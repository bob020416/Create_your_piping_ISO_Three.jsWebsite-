<!DOCTYPE html>
<html lang="en">
<head>
    <title>Build your ISO</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="icon" href="data:image/png;base64,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" type="image/x-icon">
    <link rel="shortcut icon" href="data:image/png;base64,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" type="image/x-icon">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet">


    <style>
        body {
            background-color: #f0f0f0;
            color: #444;
            font-family: Arial, sans-serif;
            margin: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }


        a {
            color: #08f;
        }
        #info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 15px;
            background-color: #eee;
            border-radius: 5px;
            width: 120px; /* set the width to your desired value */
            font-size: 14px; /* set the font size to your desired value */
            text-align: center; /* center the text */
            line-height: 1.5; /* increase the line height for better readability */
        }


        #scene {
            width: calc(100% - 150px);
            height: 100vh;
        }
        #controls {
            position: absolute;
            right: 0;
            top: 0;
            width: 150px;
            height: 100vh;
            background-color: #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            box-sizing: border-box;
        }
        button {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            background-color: #08f;
            color: #fff;
            cursor: pointer;
            margin-bottom: 10px;
        }
    </style>
    
</head>
<body>
    <div id="scene"></div>

    <div id="controls" class="card">
        <div class="card-header">
            <h5 class="card-title">Controls</h5>
        </div>
        <div class="card-body">
            <button id="addXLine" class="btn btn-primary mb-2">添加X軸線</button>
            <button id="addYLine" class="btn btn-primary mb-2">添加Y軸線</button>
            <button id="addZLine" class="btn btn-primary mb-2">添加Z軸線</button>
            <button id="deleteLine" class="btn btn-danger mb-2">刪除所選物件</button>
            <button id="addRectangle" class="btn btn-secondary mb-2">添加Valve</button>
            <button id="addArrow" class="btn btn-secondary mb-2">添加Reducer</button>
        </div>

        <div id="info" class="card-footer">
            <p><a href="https://threejs.org" target="_blank" rel="noopener">Three.js</a></p>
            <p>高速建置您的ISO圖資</p>
            <p>按住 "Shift+左鍵" 移動物件</p>
        </div>

    </div>
    
    


		<!-- Import maps polyfill -->
		<!-- Remove this when import maps will be widely supported -->

        <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>

        <script type="importmap">
        {
            "imports": {
            "three": "https://unpkg.com/three@v0.149.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@v0.149.0/examples/jsm/"
            }
        }
        </script>

		<script type="module">

			import * as THREE from 'three';
			import { DragControls } from 'three/addons/controls/DragControls.js';
            import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';


			let container;
            let camera, scene, renderer;
            let controls, group;
            let enableSelection = false;
            let orbitControls;  // Rename the variable
            
            


            let objects = [];  // Change const to let here
            let selectedObject = null;

            const mouse = new THREE.Vector2(), raycaster = new THREE.Raycaster();
            const material = new THREE.LineBasicMaterial({ color: 0x0000ff }); 

			init();

			function init() {

				container = document.getElementById('scene');

				camera = new THREE.PerspectiveCamera( 70, container.clientWidth / container.clientHeight, 0.1, 500 );
				camera.position.z = 25;

				scene = new THREE.Scene();
				scene.background = new THREE.Color( 0xf0f0f0 );

				scene.add( new THREE.AmbientLight( 0xaaaaaa ) );

				const light = new THREE.SpotLight( 0xffffff, 10000 );
				light.position.set( 0, 25, 50 );
				light.angle = Math.PI / 9;

				light.castShadow = true;
				light.shadow.camera.near = 10;
				light.shadow.camera.far = 100;
				light.shadow.mapSize.width = 1024;
				light.shadow.mapSize.height = 1024;

				scene.add( light );
                
                
                // Add grid helper
                const size = 100;
                const divisions = 100;
                const gridHelper = new THREE.GridHelper(size, divisions);
                gridHelper.rotation.x = Math.PI / 2; // Rotate grid to XZ plane
                gridHelper.translateZ(-10); // Move the grid 10 units towards negative Z
                scene.add(gridHelper);  // Add the grid to the scene

                // Create a material with the desired transparency
                const lineMaterial = new THREE.LineBasicMaterial({ transparent: true, opacity: 0.5 });

                // Iterate over the lines in the GridHelper and update their material
                gridHelper.traverse(child => {
                if (child instanceof THREE.Line) {
                    child.material = lineMaterial;
                }
                });

                scene.add(gridHelper);  // Add the grid to the scene


				group = new THREE.Group();
				scene.add( group );

                renderer = new THREE.WebGLRenderer( { antialias: true } );
                renderer.setPixelRatio( window.devicePixelRatio );
                renderer.setSize( container.clientWidth, container.clientHeight );
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFShadowMap;




                container.appendChild( renderer.domElement );

                // Set up the OrbitControls
                orbitControls = new OrbitControls(camera, renderer.domElement);
                orbitControls.enableRotate = false;  // Disable rotation

                orbitControls.screenSpacePanning = true;  // Enable 2D panning


                
                controls = new DragControls( [ ... objects ], camera, renderer.domElement );
                controls.addEventListener( 'drag', render );

				//

				window.addEventListener( 'resize', onWindowResize );

				document.addEventListener( 'click', onClick );
				window.addEventListener( 'keydown', onKeyDown );
				window.addEventListener( 'keyup', onKeyUp );

				render();

			}

			document.getElementById('addXLine').addEventListener('click', function() {
                const xPoints = [new THREE.Vector3(0, 0, 0), new THREE.Vector3(10, 10, 0)];
                const xLineMaterial = new THREE.LineBasicMaterial({ color: 0x0000ff });  // Create a new material for this line
                const xGeometry = new THREE.BufferGeometry().setFromPoints(xPoints);
                const xLine = new THREE.Line(xGeometry, xLineMaterial);  // Use the specific material
                scene.add(xLine);
                objects.push(xLine);
                updateControls();
                render();
            });

            document.getElementById('addYLine').addEventListener('click', function() {
                const yPoints = [new THREE.Vector3(0, 0, 0), new THREE.Vector3(-10, 10, 0)];
                const yLineMaterial = new THREE.LineBasicMaterial({ color: 0x0000ff });  // Create a new material for this line
                const yGeometry = new THREE.BufferGeometry().setFromPoints(yPoints);
                const yLine = new THREE.Line(yGeometry, yLineMaterial);  // Use the specific material
                scene.add(yLine);
                objects.push(yLine);
                updateControls();
                render();
            });

            document.getElementById('addZLine').addEventListener('click', function() {
                const zPoints = [new THREE.Vector3(0, 0, 0), new THREE.Vector3(0, 10, 0)];
                const zLineMaterial = new THREE.LineBasicMaterial({ color: 0x0000ff });  // Create a new material for this line
                const zGeometry = new THREE.BufferGeometry().setFromPoints(zPoints);
                const zLine = new THREE.Line(zGeometry, zLineMaterial);  // Use the specific material
                scene.add(zLine);
                objects.push(zLine);
                updateControls();
                render();
            });

			document.getElementById('deleteLine').addEventListener('click', function() {
            if (selectedObject) {
                // Remove from scene
                scene.remove(selectedObject);
                // Remove from objects array
                const index = objects.indexOf(selectedObject);
                if (index > -1) {
                    objects.splice(index, 1);
                }
                // Update controls with new objects array
                updateControls();
                // Clear selection
                selectedObject = null;
                // Render the scene
                render();
            }
        });



            document.getElementById('addRectangle').addEventListener('click', addRectangle);
            document.getElementById('addArrow').addEventListener('click', addArrow);

            function addRectangle() {
                const rectShape = new THREE.Shape();
                rectShape.moveTo(0, 0);
                rectShape.lineTo(0, 10);
                rectShape.lineTo(-2.5, 10);
                rectShape.lineTo(-2.5, 0);
                rectShape.lineTo(0, 0);

                const rectGeom = new THREE.BufferGeometry().setFromPoints(rectShape.getPoints());
                const rectLineMaterial = new THREE.LineBasicMaterial({ color: 0x0000ff });  // Create a new material for this shape
                const rectLine = new THREE.LineLoop(rectGeom, rectLineMaterial);  // Use the specific material
                scene.add(rectLine);
                objects.push(rectLine);
                updateControls();
                render();
            }


            function addArrow() {
                const arrow = new THREE.Shape();
                arrow.moveTo(0, 0);
                arrow.lineTo(2.5,0 );
                arrow.lineTo(1.25, -2.5);
                arrow.lineTo(0, 0);
                const arrowGeom = new THREE.BufferGeometry().setFromPoints(arrow.getPoints());
                const arrowLineMaterial = new THREE.LineBasicMaterial({ color: 0x0000ff });  // Create a new material for this shape
                const arrowLine = new THREE.LineLoop(arrowGeom, arrowLineMaterial);  // Use the specific material
                scene.add(arrowLine);
                objects.push(arrowLine);
                updateControls();
                render();
            }

        


			function onWindowResize() {

				camera.aspect = container.clientWidth / container.clientHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( container.clientWidth, container.clientHeight );

				render();

			}

			function onKeyDown( event ) {

				enableSelection = ( event.keyCode === 16 ) ? true : false;

			}

			function onKeyUp() {

				enableSelection = false;

			}

            

			function onClick(event) {
                event.preventDefault();

                const rect = container.getBoundingClientRect();
                mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

                raycaster.setFromCamera(mouse, camera);

                const intersections = raycaster.intersectObjects(objects, true);

                if (intersections.length > 0) {
                    const object = intersections[0].object;

                    if (object !== selectedObject) {
                        if (selectedObject) {
                            // Deselect the previously selected object
                            selectedObject.material.color.set(0x0000ff);
                        }

                        // Select the new object
                        selectedObject = object;
                        selectedObject.material.color.set(0xffff00);
                    } else {
                        // Deselect the current selected object
                        selectedObject.material.color.set(0x0000ff);
                        selectedObject = null;
                    }

                    render();
                }
            }



            function updateControls() {
                if (controls) {
                    // Detach old controls
                    controls.dispose();
                }

                // Create new controls with updated objects
                controls = new DragControls(objects, camera, renderer.domElement);
                controls.addEventListener('drag', render);
            }





			function render() {
                orbitControls.update();  // Update the orbit controls before rendering
                renderer.render( scene, camera );
            }


		</script>

	</body>
</html>

